
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preprocessing &#8212; Diffusion MRI</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Fibre Estimation" href="postprocessing.html" />
    <link rel="prev" title="Introduction" href="introduction.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      <h1 class="site-logo" id="site-title">Diffusion MRI</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../main.html">
   UCL Summer School: Diffusion MRI
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Diffusion
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../diffusion/introduction.html">
   Introduction to Diffusion MRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../diffusion/diffusion_test.html">
   Check your Understanding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../diffusion/coding_assignment.html">
   Coding Assignment
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tractography
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tractography/introduction.html">
   Introduction to Tractography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tractography/tractography_test.html">
   Check your Understanding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tractography/coding_assignment.html">
   Coding Assignment
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Advanced Tractography
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   MRtrix3 Introduction
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   MRtrix3 DWI Preprocessing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="postprocessing.html">
   MRtrix3 DWI Fibre Estimation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tractography.html">
   MRtrix3 Tractography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="connectome.html">
   MRtrix3 Connectome Generation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="coding_assignment.html">
   Coding Assignment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bash_intro.html">
   Bash Introduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Machine Learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../deep_learning/introduction.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Anonymous Feedback
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../feedback/feedback.html">
   Feedback
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/pages/advanced_tractography/preprocessing.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/diffusion-tractography/diffusion-tractography.github.io/tree/main"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/diffusion-tractography/diffusion-tractography.github.io/tree/main/issues/new?title=Issue%20on%20page%20%2Fpages/advanced_tractography/preprocessing.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/tree/main/edit/master/pages/advanced_tractography/preprocessing.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#converting-to-mrtrix3-format">
   Converting to MRtrix3 Format
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#viewing-our-image">
   Viewing our Image
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#denoising">
   Denoising
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gibbs-ringing-correction">
   Gibbs Ringing Correction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#distortion-correction-eddy">
   Distortion correction [EDDY]
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#field-bias-correction">
   Field Bias Correction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="preprocessing">
<h1>Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this headline">¶</a></h1>
<p><em>by Lawrence Binding</em></p>
<div class="tip admonition">
<p class="admonition-title">Estimated Time</p>
<p>30 minutes</p>
</div>
<p>So MRtrix3 is run through lines of code, this can be slightly daunting at first but allows us more freedom when running tractography on large datasets. If you are unfamiliar with how to use the terminal (Mac) or MSYS2 (Windows) then please see the bash introduction page for a quick how-to.</p>
<ul class="simple">
<li><p>DATA: https://github.com/diffusion-tractography/diffusion-tractography.github.io/tree/main/DATA/advanced_tractography</p></li>
</ul>
<p>The first thing we need to do with our diffusion data is to clean it. Diffusion data is messy, very messy and the signal to noise radio is small, very small. The best way we can improve this is by using various correction methods on our diffusion data.</p>
<style>
h1 {text-align: center;}
h2 {text-align: center;}
</style>
<hr class="docutils" />
<div class="section" id="converting-to-mrtrix3-format">
<h2>Converting to MRtrix3 Format<a class="headerlink" href="#converting-to-mrtrix3-format" title="Permalink to this headline">¶</a></h2>
<p>To begin with, we need to get the data in MRtrix3 format (.mif) so we can use their tools. So in the advanced_tractography folder we have our fibrecup.nii.gz, bvec and bval files. So far we’ve been working with grad.txt which contains both bvec (columns 1-3) and bvals (column 4). You may encounter them separated which is known as the fsl format so its good to know how to handle this. We are able to add all these files together with the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mrconvert fibrecup.nii.gz -fslgrad bvecs bvals fibrecup.mif 
</pre></div>
</div>
<p>The above command tells our terminal to use MRtrix3 mrconvert command to take our fibrecup.nii.gz, import the fsl style gradients bvecs and bvals, and output them in MRtrix3 format .mif. the MIF format contains the bvecs and bvals in the header information, which means less can go wrong!</p>
</div>
<hr class="docutils" />
<div class="section" id="viewing-our-image">
<h2>Viewing our Image<a class="headerlink" href="#viewing-our-image" title="Permalink to this headline">¶</a></h2>
<p>Now we’ve got our diffusion in MRtrix3 format, lets view our image using the below command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mrview  fibrecup.mif
</pre></div>
</div>
<p>Here we are telling mrview (MRtrix3 viewing software) to open fibrecup.mif</p>
</div>
<hr class="docutils" />
<div class="section" id="denoising">
<h2>Denoising<a class="headerlink" href="#denoising" title="Permalink to this headline">¶</a></h2>
<p>So lets move onto preprocessing the data, first we should denoise our DWI image, this removes thermal noise in the image using the Marchenko-Pastur PCA method. This must be done before any other types of processing is undertaken:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dwidenoise fibrecup.mif fibrecup_denoise.mif -noise noise.mif
</pre></div>
</div>
<p>To check our results we need to calculate the difference between the raw and denoised images:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mrcalc fibrecup.mif fibrecup_denoise.mif -subtract denoise_difference.mif 
mrview noise.mif denoise_difference.mif
</pre></div>
</div>
<figure>
<img src="../../_static/img/dwidenoise.png" alt="colab" style="width:396px;height:239px;">
<figcaption>Fig.1 - Before (left) and after (right) using dwidenoise.</figcaption>
</figure>
</div>
<hr class="docutils" />
<div class="section" id="gibbs-ringing-correction">
<h2>Gibbs Ringing Correction<a class="headerlink" href="#gibbs-ringing-correction" title="Permalink to this headline">¶</a></h2>
<p>Next we need to remove Gibb’s ringing artifacts. These occur due to limitations in the fourier transformation.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mrdegibbs fibrecup_denoise.mif fibrecup_denoise_gibbs.mif
</pre></div>
</div>
<p>To check our results, we can culate the difference and inspect them.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mrcalc fibrecup_denoise.mif fibrecup_denoise_gibbs.mif -subtract residual.mif
mrview fibrecup_denoise_gibbs.mif residual.mif
</pre></div>
</div>
<figure>
<img src="../../_static/img/ringing.png" alt="colab" style="width:363px;height:336px;">
<figcaption>Fig.2 - Before (left) and after (right) using mrdegibbs.</figcaption>
</figure>
</div>
<hr class="docutils" />
<div class="section" id="distortion-correction-eddy">
<h2>Distortion correction [EDDY]<a class="headerlink" href="#distortion-correction-eddy" title="Permalink to this headline">¶</a></h2>
<p>NOTE: THIS TAKES AGES! Don’t attempt this on fibrecup!</p>
<p>There are several different methods of correcting for distortions induced by motion and eddy all with different advantages/disadvantages. Synb0-DISCO is a newer method which doesn’t require any additional acquisitions in scanner not only saving time but also retrospective data. However, this is run in Docker and we don’t have time to tell you about this. Instead we’re going to be using a tool called EDDY which is packaged in MRtrix3 as dwipreproc.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dwipreproc fibrecup_denoise_gibbs.mif fibrecup_denoise_gibbs_preproc.mif -rpe_none -pe_dir ap
</pre></div>
</div>
<ul class="simple">
<li><p>-rpe_none: is telling dwipreproc we don’t have a reverse phase encoding gradient</p></li>
<li><p>-pe_dir: is telling dwipreproc the acquisition direction (anterior-posterior) (fibrecup doesn’t actually have an aqusition method so its here just for demonstration)</p></li>
</ul>
<figure>
<img src="../../_static/img/eddy.png" alt="colab" style="width:435px;height:278px;">
<figcaption>Fig.3 - Before (left) and after (right) using dwipreproc.</figcaption>
</figure>
</div>
<div class="section" id="field-bias-correction">
<h2>Field Bias Correction<a class="headerlink" href="#field-bias-correction" title="Permalink to this headline">¶</a></h2>
<p>To improve brain mask estimation and comparison between subjects, we need to run a bias field correction which will normalise the image.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dwibiascorrect -fsl fibrecup_denoise_gibbs_preproc.mif fibrecup_denoise_gibbs_preproc_biasCorr.mif -bias bias.mif 
</pre></div>
</div>
<ul class="simple">
<li><p>-fsl is telling the software to use fsl method of bias correction, you can also use -ants.</p></li>
</ul>
<p>To check the bias field we just load that into mrview.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mrview bias.mif -colourmap <span class="m">2</span>  
</pre></div>
</div>
<figure>
<img src="../../_static/img/biascorrect.png" alt="colab" style="width:540px;height:201px;">
<figcaption>Fig.4 - Before (left) and after (right) using dwibiascorrect.</figcaption>
</figure>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>There are a lot of steps required to ensure your diffusion data is the best it can be. Here we have covered the most advanced and readily available in MRtrix3. From this you will now confidently be able to analyse your diffusion data!</p>
<style>
  .iframe-container {
		text-align:center;
  		width:100%;
  }
</style>
<div class="admonition-further-reading admonition">
<p class="admonition-title">Further reading</p>
<ul class="simple">
<li><p>https://mrtrix.readthedocs.io/en/latest/reference/commands/dwidenoise.html</p></li>
<li><p>https://mrtrix.readthedocs.io/en/latest/reference/commands/mrdegibbs.html</p></li>
<li><p>https://mrtrix.readthedocs.io/en/3.0_rc1/reference/scripts/dwipreproc.html</p></li>
<li><p>https://mrtrix.readthedocs.io/en/latest/reference/commands/dwibiascorrect.html</p></li>
</ul>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./pages/advanced_tractography"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="introduction.html" title="previous page">Introduction</a>
    <a class='right-next' id="next-link" href="postprocessing.html" title="next page">Fibre Estimation</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By UCL–CMIC Summer School<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>